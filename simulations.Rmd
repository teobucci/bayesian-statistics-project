---
title: "Stochastic Block Model Prior with Ordering Constraints for Gaussian Graphical Models"
output:
    html_document:
        toc: true
        toc_float: true
        number_sections: true
    pdf_document:
        toc: true
        toc_depth: 3
        number_section: true
date: "2023-01-17"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Simulations

## Load the necessary packages

```{r}
suppressWarnings(suppressPackageStartupMessages(library(tidyverse)))
suppressWarnings(suppressPackageStartupMessages(library(ACutils)))
suppressWarnings(suppressPackageStartupMessages(library(mvtnorm)))
suppressWarnings(suppressPackageStartupMessages(library(salso)))
suppressWarnings(suppressPackageStartupMessages(library(FGM)))
suppressWarnings(suppressPackageStartupMessages(library(gmp)))
suppressWarnings(suppressPackageStartupMessages(library(mcclust)))
suppressWarnings(suppressPackageStartupMessages(library(mcclust.ext)))
suppressWarnings(suppressPackageStartupMessages(library(logr)))
```

```{r}
paths = c(
    "src/utility_functions.R",
    "src/bulky_functions.R",
    "src/data_generation.R"
)

for(p in paths){
    path = file.path(p)
    if(file.exists(path)){
        source(path)
    } else {
        cat("File",path,"wasn't found in directory, please check.")
    }
}
```


## Generate data

```{r}
# Define true clustering
z_true = c(1,1,1,1,1,1,1, # cluster 1
           2,2,2,2,2,2,2, # cluster 2
           3,3,3,3,3,3,3) # cluster 3

# Define data dimension
p = length(z_true)
n = 500

# z_to_rho(z_true)
# z_to_r(z_true)

# Generate data
sim = Generate_BlockDiagonal(n = n, z_true = z_true)
#sim = Generate_Block(n = n, z_true = z_true)

ACutils::ACheatmap(sim$G,use_x11_device = F,horizontal = F, main = "Graph", 
                  center_value = NULL,  
                  col.upper = "black",
                  col.center = "grey50",
                  col.lower = "white")
                  
# Plot Cov
ACutils::ACheatmap(sim$Cov,use_x11_device = F,horizontal = F, main = "Covariance", 
                   center_value = NULL,  
                   col.upper = "black",
                   col.center = "grey50",
                   col.lower = "white")

```

```{r}
Prec_true = sim$Prec # precision matrix
Graph_true = sim$Graph # true graph
Graph_true[col(Graph_true)==row(Graph_true)] = 0 # remove self loops

graph_density = sum(sim$Graph) / (p*(p-1))
```

## Set options for the simulation

```{r}
# https://stackoverflow.com/a/57571028/16222204
# Use TRUE/FALSE instead of T/F

options = set_options(sigma_prior_0=0.5,
                      sigma_prior_parameters=list("a"=1,"b"=1,"c"=1,"d"=1),
                      theta_prior_0=1,
                      theta_prior_parameters=list("c"=1,"d"=1),
                      rho0=p, # start with one group
                      weights_a0=rep(1,p-1),
                      weights_d0=rep(1,p-1),
                      alpha_target=0.234,
                      mu_beta=graph_density,
                      sig2_beta=1/16,
                      d=3,
                      alpha_add=0.5,
                      adaptation_step=1/(p*1000), # as suggested in Benson
                      update_sigma_prior=TRUE,
                      update_theta_prior=TRUE,
                      update_weights=TRUE,
                      update_partition=TRUE,
                      update_graph=TRUE,
                      perform_shuffle=TRUE)
```


## Running the simulation

```{r}

#introducing a proper name
filename=paste('sim',as.character(n), as.character(p),sep='_')
    
log_open(file_name = filename, show_notes=FALSE)
res <- Gibbs_sampler(
    data = data,
    niter = 500,
    nburn = 1,
    thin = 1,
    options = options,
    seed = 123456,
    print = TRUE
)
log_close()
```


```{r}
res$z
```
